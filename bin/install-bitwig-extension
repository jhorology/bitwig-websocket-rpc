#!/usr/bin/env node

const fs = require('fs');
const os = require('os');
const path = require('path');
const program = require('commander');
const updateNotifier = require('update-notifier');
const pkg = require('../package.json');

const notifier = updateNotifier({pkg});
if (notifier.update && notifier.update.latest !== pkg.version) {
    notifier.notify({defer: false});
}

const extensionFileName = 'WebSocketRpcServer.bwextension';
const defaultExtensionDir = (function() {
  switch (process.platform) {
    case 'win32':
      return path.join(os.homedir(), 'Documents', 'Bitwig Studio', 'Extensions');
    case 'darwin':
      return path.join(os.homedir(), 'Documents', 'Bitwig Studio', 'Extensions');
    case 'linux':
      return path.join(os.homedir(), 'Bitwig Studio', 'Extensions');
    default:
      console.error(`Unsupported Platform:[${process.platform}].`);
      return process.exit(1);
  }
})();

program
  .description('Install WebSockets RPC server extension.')
  .usage('[options]')
  .option('-e, --extensionDir <path>', `The path of Bitwig Studio's Extension folder. (default: ${defaultExtensionDir})`)
  .option('-v, --version', pkg.version, () => {
    console.log(pkg.version);
    process.exit(0);
  })
  .option('-V', '', () => {
    console.log(pkg.version);
    process.exit(0);
  })
  .parse(process.argv);

const extensionDir = program.extensionDir ? program.extensionDir : defaultExtensionDir;

if (!(fs.existsSync(extensionDir) && fs.statSync(extensionDir).isDirectory())) {
  console.error("Couldn't find a Bitwig Studio's Extension directory.");
  process.exit(1);
}

fs.copyFileSync(path.join(__dirname, '..', extensionFileName),
                path.join(extensionDir, extensionFileName));

console.info('Installation completed successfull.');
